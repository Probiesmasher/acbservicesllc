<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>ACB Services — 3D Prints</title>
<meta content="ACB Services — custom 3D printed items. Order online via PayPal." name="description"/>
<style>
    :root {
      --bg: #0b0c10;
      --card: #121318;
      --text: #e8eaf1;
      --muted: #9aa3b2;
      --accent: #4cc9f0;
      --accent-2: #80ed99;
      --radius: 16px;
      --overlay: rgba(3,7,18,0.6);
      --panel: #0f1220;
      --panel-border: #22283a;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: linear-gradient(180deg, #0b0c10, #0d1220); color: var(--text); }
    header { padding: 34px 24px 10px; text-align: center; }
    .headrow { display: inline-flex; align-items: center; gap: 14px; }
    .brand { font-size: clamp(28px, 4vw, 44px); font-weight: 800; letter-spacing: 0.5px; }
    .logo { width: 64px; height: 64px; border-radius: 12px; border: 1px solid #263046; background:#0d1220; }
    .tag { color: var(--muted); margin-top: 8px; font-size: 14px; }
    .container { width: min(1100px, 94vw); margin: 24px auto 64px; }
    .notice { background: #111827; border: 1px solid #1f2937; padding: 14px 16px; border-radius: 12px; color: var(--muted); font-size: 14px; }

    /* Grid Catalog */
    .catalog-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 18px;
      margin-top: 18px;
    }
    @media (max-width: 1100px) { .catalog-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 860px)  { .catalog-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 560px)  { .catalog-grid { grid-template-columns: 1fr; } }

    .card {
      background: var(--card);
      border: 1px solid #232634;
      border-radius: var(--radius);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-width: 0; /* fight overflowing content */
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
      cursor: pointer;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 0 0 2px rgba(47,126,233,.15); }
    .thumb { aspect-ratio: 16/10; background: #0f172a; display: grid; place-items: center; color: #94a3b8; font-size: 13px; border-bottom: 1px solid #1f2937; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .card-body { padding: 16px; display: flex; flex-direction: column; gap: 10px; min-height: 260px; }
    .title { font-weight: 700; font-size: 18px; }
    .desc { color: var(--muted); font-size: 14px; line-height: 1.35; }
    .push { flex: 1 1 auto; }
    .price { margin-top: 6px; font-weight: 700; }

    .btnrow { display: grid; grid-template-columns: 1fr; gap: 10px; align-items: stretch; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; border-radius: 12px; padding: 10px 12px; text-decoration: none; font-weight: 700; font-size: 14px; border: 1px solid transparent; cursor: pointer; }
    .btn.paypal { background: #0d1220; border-color: #283044; color: #ffc439; }
    .btn:hover { filter: brightness(1.08); }
    .btn.disabled { opacity: .55; cursor: not-allowed; }

    .footer { margin-top: 48px; padding: 32px 0 56px; color: var(--muted); font-size: 14px; text-align: center; }
    .legal { opacity: 0.8; font-size: 12px; margin-top: 12px; }
    .contact { margin-top: 28px; text-align: center; }
    .contact a { color: var(--accent); text-decoration: none; }

    .badge { display:inline-block; padding: 2px 8px; border: 1px solid #1f2937; border-radius: 999px; color: #9aa3b2; font-size: 12px; }

    /* Modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; }
    .modal.open { display: flex; }
    .modal .overlay { position: absolute; inset: 0; background: var(--overlay); backdrop-filter: blur(2px); }
    .modal .panel {
      position: relative; background: var(--panel); border: 1px solid var(--panel-border);
      width: min(980px, 94vw); max-height: 88vh; border-radius: 20px; overflow: hidden;
      display: grid; grid-template-columns: 1.1fr 1fr;
     overflow-y: auto;
    }
    
    .panel.single { grid-template-columns: 1fr; }
.panel .media { position: relative; background: #0c1322; display: grid; place-items: center;  max-height: 70vh;}
    .panel .media img { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; display: block; }
    .panel .mnav {
      position: absolute; top: 50%; transform: translateY(-50%);
      width: 40px; height: 40px; border-radius: 999px; border: 1px solid #2a3248;
      background:#0d1220; color:#e8eaf1; cursor:pointer; font-size: 20px;
      display: grid; place-items: center;
    }
    .panel .mnav.prev { left: 10px; }
    .panel .mnav.next { right: 10px; }
    .panel .thumbs {
      display:flex; gap:8px; padding:10px; overflow-x:auto; background:#0b1324; border-top:1px solid #1e2435;
      grid-column: 1 / -1; /* span full width under the main image */
    }
    .panel .thumbs img { width:72px; height:54px; object-fit:cover; border-radius:8px; opacity:.75; cursor:pointer; border:1px solid transparent; }
    .panel .thumbs img.active { opacity:1; border-color:#2f7ee9; }
    .panel .content { padding: 20px; display: flex; flex-direction: column; gap: 12px;  min-height: 0; overflow-y: auto; }

    .panel h3 { margin: 0; font-size: 24px; }
    .panel .longdesc { color: var(--muted); line-height: 1.45; }
    .panel .price { font-weight: 800; font-size: 18px; }
    .panel .options { display:flex; gap:12px; align-items:center; }
    .panel label { font-size:14px; color:var(--muted); }
    .panel select { background:#0d1220; color:#e8eaf1; border:1px solid #2a3248; border-radius:10px; padding:6px 10px; }
    .panel .btnrow { margin-top: 4px; }
    .panel .close {
      position: absolute; top: 10px; right: 10px; width: 38px; height: 38px; border-radius: 50%;
      border: 1px solid #2a3248; background:#0d1220; color:#e8eaf1; cursor:pointer; font-size: 20px;
    }
    @media (max-width: 860px) {
      .panel { grid-template-columns: 1fr; max-height: 92vh; }
      .panel .media { max-height: 70vh; }
    }
  </style>
</head>
<body>
<header>
<div class="headrow">
<img alt="ACB logo" class="logo" src="data:image/svg+xml;utf8,&lt;?xml version='1.0' encoding='UTF-8'?&gt;&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'&gt;&lt;defs&gt;&lt;linearGradient id='g' x1='0' y1='0' x2='1' y2='1'&gt;&lt;stop offset='0' stop-color='%234cc9f0'/&gt;&lt;stop offset='1' stop-color='%2380ed99'/&gt;&lt;/linearGradient&gt;&lt;/defs&gt;&lt;rect width='128' height='128' rx='20' ry='20' fill='%2310152a' stroke='%23263046' stroke-width='6'/&gt;&lt;g fill='url(%23g)' font-family='Verdana' font-weight='700' font-size='56'&gt;&lt;text x='18' y='76'&gt;AC&lt;/text&gt;&lt;text x='72' y='76'&gt;B&lt;/text&gt;&lt;/g&gt;&lt;/svg&gt;"/>
<div class="brand">ACB Services</div>
</div>
<div class="tag">Custom 3D-printed gear • Made to order in Ohio</div>
</header>
<main class="container">
<div class="notice">“Pay with PayPal” uses PayPal Buttons. Shipping is calculated on checkout where supported or noted in the item.</div>
<section style="margin-top: 22px;">
<h2 style="margin:0 0 8px; font-size: 22px;">Catalog</h2>
<!-- Grid of products (no horizontal scrollbar, wraps to new rows) -->
<div class="catalog-grid" id="catalog">
<!-- Product 1 -->
<article class="card" data-amount="5.00" data-colors="Brown|White" data-image="https://cdn.jsdelivr.net/gh/Probiesmasher/acbservicesllc@main/assets/holiday/halloween/jason1.jpg" data-images="https://cdn.jsdelivr.net/gh/Probiesmasher/acbservicesllc@main/assets/holiday/halloween/jason1.jpg,https://cdn.jsdelivr.net/gh/Probiesmasher/acbservicesllc@main/assets/holiday/halloween/jason2.jpg" data-longdesc="Tiny size, killer vibes. Jason Flexi-Fig is your pocket-sized slasher buddy — 3D printed and flexi for just the right amount of menace." data-price="$5.00" data-title=" Jason Flexi-Fig (PLA)">
<div class="thumb"><img alt="Jason Flexi-Fig" loading="lazy" src="https://cdn.jsdelivr.net/gh/Probiesmasher/acbservicesllc@main/assets/holiday/halloween/jason1.jpg"/></div>
<div class="card-body">
<div class="title">Jason Flexi-Fig (PLA)</div>
<div class="desc">Tiny size, killer vibes. Jason Flexi-Fig is your pocket-sized slasher buddy — 3D printed and flexi for just the right amount of menace. Colors: Brown/White. Finish: Standard.</div>
<div class="push"></div>
<div class="price">$5.00</div>
<div class="btnrow">
<div aria-label="Pay with PayPal" class="btn paypal" data-amount="5.00" data-item="Jason Flexi-Fig" data-nomodal=""></div>
</div>
<span class="badge">Lead time: 2–4 days</span>
</div>
</article>
<!-- Product 2 -->
<article class="card" data-amount="9.00" data-colors="Black|White" data-image="https://placehold.co/1200x800/png?text=Cable+Clips" data-images="https://placehold.co/1200x800/png?text=Cable+Clips+1,https://placehold.co/1200x800/png?text=Cable+Clips+2" data-longdesc="Six-pack of low-profile cable clips to tame the chaos under (and on) your desk. PLA. Colors: Black, White. Includes adhesive backing." data-price="$9.00" data-title="Cable Clips (6pk)">
<div class="thumb"><img alt="Cable clips preview" loading="lazy" src="https://placehold.co/520x325/png?text=Cable+Clips"/></div>
<div class="card-body">
<div class="title">Cable Clips (6pk)</div>
<div class="desc">Clip set for desk cable management. Colors: Black/White.</div>
<div class="push"></div>
<div class="price">$9.00</div>
<div class="btnrow">
<div aria-label="Pay with PayPal" class="btn paypal" data-amount="9.00" data-item="Cable Clips (6pk)" data-nomodal=""></div>
</div>
<span class="badge">Lead time: 1–3 days</span>
</div>
</article>
<!-- Product 3 -->
<article class="card" data-amount="28.00" data-colors="Black|Marble Gray" data-image="https://placehold.co/1200x800/png?text=Dice+Tower" data-images="https://placehold.co/1200x800/png?text=Dice+Tower+1,https://placehold.co/1200x800/png?text=Dice+Tower+2,https://placehold.co/1200x800/png?text=Dice+Tower+3,https://placehold.co/1200x800/png?text=Dice+Tower+4" data-longdesc="Smooth-rolling tabletop dice tower printed in PETG for durability. Options: Black, Marble Gray. Finish: Fine layer height. Perfect for RPG nights." data-price="$28.00" data-title="Dice Tower (PETG)">
<div class="thumb"><img alt="Dice tower preview" loading="lazy" src="https://placehold.co/520x325/png?text=Dice+Tower"/></div>
<div class="card-body">
<div class="title">Dice Tower (PETG)</div>
<div class="desc">Tabletop dice tower. Colors: Black/Marble Gray. Finish: Fine.</div>
<div class="push"></div>
<div class="price">$28.00</div>
<div class="btnrow">
<div aria-label="Pay with PayPal" class="btn paypal" data-amount="28.00" data-item="Dice Tower (PETG)" data-nomodal=""></div>
</div>
<span class="badge">Lead time: 3–6 days</span>
</div>
</article>
<!-- Product 4 -->
<article class="card" data-amount="7.00" data-colors="Black|White" data-image="https://placehold.co/1200x800/png?text=Wall+Hook" data-images="https://placehold.co/1200x800/png?text=Wall+Hook+1,https://placehold.co/1200x800/png?text=Wall+Hook+2" data-longdesc="Compact utility wall hook, PETG for strength. Great for keys, hats, or light bags. Colors: Black, White. Includes screws." data-price="$7.00" data-title="Wall Hook (PETG)">
<div class="thumb"><img alt="Wall hook preview" loading="lazy" src="https://placehold.co/520x325/png?text=Wall+Hook"/></div>
<div class="card-body">
<div class="title">Wall Hook (PETG)</div>
<div class="desc">Durable utility hook. Colors: Black/White. Includes screws.</div>
<div class="push"></div>
<div class="price">$7.00</div>
<div class="btnrow">
<div aria-label="Pay with PayPal" class="btn paypal" data-amount="7.00" data-item="Wall Hook (PETG)" data-nomodal=""></div>
</div>
<span class="badge">Lead time: 1–2 days</span>
</div>
</article>
<!-- Product 5 -->
<article class="card" data-amount="14.00" data-colors="Black|White|Gray" data-image="https://placehold.co/1200x800/png?text=Hex+Coasters" data-images="https://placehold.co/1200x800/png?text=Hex+Coasters+1,https://placehold.co/1200x800/png?text=Hex+Coasters+2,https://placehold.co/1200x800/png?text=Hex+Coasters+3" data-longdesc="Honeycomb coasters with cork backing. Multiple colors to match your desk setup. Heat-resistant up to typical mug temps." data-price="$14.00" data-title="Hex Coasters (Set of 4)">
<div class="thumb"><img alt="Hex coasters preview" loading="lazy" src="https://placehold.co/520x325/png?text=Hex+Coasters"/></div>
<div class="card-body">
<div class="title">Hex Coasters (Set of 4)</div>
<div class="desc">Honeycomb coasters with cork backing. Multiple colors.</div>
<div class="push"></div>
<div class="price">$14.00</div>
<div class="btnrow">
<div aria-label="Pay with PayPal" class="btn paypal" data-amount="14.00" data-item="Hex Coasters (Set of 4)" data-nomodal=""></div>
</div>
<span class="badge">Lead time: 2–3 days</span>
</div>
</article>
</div>
</section>
<section class="contact">
<h3>Custom Print?</h3>
<p>Need a custom size or part? Email <a href="mailto:orders@acbservices.shop">orders@acbservices.shop</a> with your STL and we’ll quote it.</p>
</section>
<section class="footer">
<div>© <span id="year"></span> ACB Services • North Ridgeville, OH</div>
<div class="legal">3D prints may show light layer lines. PLA items should not be left in hot cars or direct sunlight. Returns accepted for print defects only within 14 days of delivery.</div>
</section>
</main>
<!-- Modal -->
<div aria-hidden="true" class="modal" id="productModal">
<div class="overlay" data-close=""></div>
<div aria-labelledby="modalTitle" aria-modal="true" class="panel" role="dialog">
<button aria-label="Close" class="close" data-close="">×</button>
<div class="media">
<img alt="Large product image" id="modalImage"/>
<button aria-label="Prev image" class="mnav prev">‹</button>
<button aria-label="Next image" class="mnav next">›</button>
</div>
<div class="thumbs" id="modalThumbs"></div>
<div class="content">
<h3 id="modalTitle"></h3>
<p class="longdesc" id="modalDesc"></p>
<div class="options">
<label for="modalColor">Color</label>
<select aria-label="Select color" id="modalColor"></select>
</div>
<div class="price" id="modalPrice"></div>
<div class="btnrow">
<div id="modalPaypal"></div>
</div>
</div>
</div>
</div>
<!-- PayPal JavaScript SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=YOUR_REAL_PAYPAL_CLIENT_ID¤cy=USD&amp;components=buttons"></script>
<script>
function getConfiguredPaypalClientId() {
      const tag = document.querySelector('script[src*="paypal.com/sdk/js"]');
      try { return new URL(tag.src).searchParams.get('client-id'); } catch (e) { return null; }
    }
    function ensurePaypalLoaded() {
      return new Promise(function(resolve) {
        if (window.paypal && paypal.Buttons) return resolve();
        const id = getConfiguredPaypalClientId();
        if (!id || id === 'YOUR_REAL_PAYPAL_CLIENT_ID') return resolve();
        const s = document.createElement('script');
        s.src = 'https://www.paypal.com/sdk/js?client-id=' + encodeURIComponent(id) + '&currency=USD&components=buttons';
        s.onload = () => resolve();
        s.onerror = () => resolve();
        document.head.appendChild(s);
      });
    }
    function renderPaypalInto(target, getData) {
      target.innerHTML = '';
      if (window.paypal && paypal.Buttons) {
        paypal.Buttons({
          style: { layout: 'horizontal', height: 40, label: 'paypal' },
          createOrder: function(data, actions) {
            const d = getData();
            const desc = d.color ? (d.item + ' — Color: ' + d.color) : d.item;
            return actions.order.create({
              purchase_units: [{ description: desc, amount: { value: d.amount } }]
            });
          },
          onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
              const d = getData();
              alert('Thanks ' + (details.payer?.name?.given_name || 'friend') + '! Your order for ' + d.item + (d.color ? (' (' + d.color + ')') : '') + ' was paid.');
            });
          },
          onError: function(err) {
            console.error('PayPal error', err);
            alert('PayPal checkout error. Please try again.');
          }
        }).render(target);
      } else {
        const btn = document.createElement('button');
        btn.className = 'btn paypal disabled';
        btn.textContent = 'Pay with PayPal (configure client ID)';
        target.appendChild(btn);
      }
    }
    function renderPayPalButtonsOnCards() {
      document.querySelectorAll('.btn.paypal').forEach(function(el){
        const amount = el.dataset.amount;
        const item = el.dataset.item;
        const container = document.createElement('div');
        container.className = 'paypal-container';
        container.style.width = '100%';
        el.replaceWith(container);
        renderPaypalInto(container, () => ({ item, amount }));
      });
    }

    (function () {
      const modal = document.getElementById('productModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalDesc = document.getElementById('modalDesc');
      const modalPrice = document.getElementById('modalPrice');
      const modalImage = document.getElementById('modalImage');const modalPaypal = document.getElementById('modalPaypal');
      const modalThumbs = document.getElementById('modalThumbs');
      const modalColor = document.getElementById('modalColor');
      const mPrev = modal.querySelector('.mnav.prev');
      const mNext = modal.querySelector('.mnav.next');
      let imgs = [], idx = 0, lastFocus = null, itemName = '', amount = '';

      
      function setPanelLayoutByAspect(w, h) {
        const ratio = (w && h) ? (w / h) : 1;
        // If portrait-ish (tall images), use single column to avoid empty right space
        if (ratio < 1.25) {
          modal.querySelector('.panel').classList.add('single');
        } else {
          modal.querySelector('.panel').classList.remove('single');
        }
      }

      function sizeMediaToImage(w, h) {
        try {
          const panelEl = modal.querySelector('.panel');
          const media = modal.querySelector('.media');
          const vw = Math.min(window.innerWidth * 0.94, 980);
          const maxH = Math.min(window.innerHeight * 0.70, 900);
          const ratio = (w && h) ? (w / h) : 1;
          if (panelEl.classList.contains('single')) {
            // Compute width so height stays within maxH
            let height = Math.min(maxH, vw / ratio);
            let width = Math.min(vw, height * ratio);
            if (height > maxH) { height = maxH; width = height * ratio; }
            media.style.height = height + 'px';
            media.style.width = width + 'px';
            media.style.justifySelf = 'center';
          } else {
            media.style.height = '';
            media.style.width = '';
            media.style.justifySelf = '';
          }
        } catch (e) {}
      }
function setImage(i) {
        idx = (i + imgs.length) % imgs.length;
        const src = imgs[idx];
        // Reset aspect ratio until the image loads
        modalImage.removeAttribute('width');
        modalImage.removeAttribute('height');
        modalImage.src = src;
        // Once loaded, set the media container's aspect-ratio to match the image
        modalImage.onload = function() {
          try {
            const w = modalImage.naturalWidth || 1;
            const h = modalImage.naturalHeight || 1;
            modal.querySelector('.media').style.aspectRatio = w + ' / ' + h;
            setPanelLayoutByAspect(w, h);
            sizeMediaToImage(w, h);
          } catch (e) { /* no-op */ }
        };
        Array.from(modalThumbs.querySelectorAll('img')).forEach((im, n) => im.classList.toggle('active', n === idx));
      }
      function buildThumbs() {
        modalThumbs.innerHTML = '';
        imgs.forEach((src, i) => {
          const t = document.createElement('img');
          t.src = src; if (i === idx) t.classList.add('active');
          t.addEventListener('click', () => setImage(i));
          modalThumbs.appendChild(t);
        });
      }
      function setColors(list) {
        modalColor.innerHTML = '';
        (list || []).forEach(c => {
          const opt = document.createElement('option');
          opt.value = opt.textContent = c;
          modalColor.appendChild(opt);
        });
      }
      function openModal(data) {
        lastFocus = document.activeElement;
        itemName = data.title || '';
        amount = data.amount || '';
        modalTitle.textContent = itemName;
        modalDesc.textContent = data.longdesc || '';
        modalPrice.textContent = data.price || '';imgs = data.images && data.images.length ? data.images.slice() : (data.image ? [data.image] : []);
        idx = 0; if (imgs.length) { setImage(0); buildThumbs(); } else { modalImage.removeAttribute('src'); modalThumbs.innerHTML = ''; }
        setColors(data.colors || []);
        // If the image might be cached, attempt setting aspect ratio immediately
        if (modalImage.complete && modalImage.naturalWidth && modalImage.naturalHeight) {
          modal.querySelector('.media').style.aspectRatio = modalImage.naturalWidth + ' / ' + modalImage.naturalHeight;
          setPanelLayoutByAspect(modalImage.naturalWidth, modalImage.naturalHeight);
          sizeMediaToImage(modalImage.naturalWidth, modalImage.naturalHeight);
        }
        renderPaypalInto(modalPaypal, () => ({ item: itemName, amount, color: modalColor.value }));
        modal.classList.add('open'); modal.setAttribute('aria-hidden', 'false');
        function _onResize(){ if (modalImage.naturalWidth && modalImage.naturalHeight) sizeMediaToImage(modalImage.naturalWidth, modalImage.naturalHeight); }
        window.addEventListener('resize', _onResize);
        modal._cleanup = () => window.removeEventListener('resize', _onResize);
        (modal.querySelector('.close') || modal).focus();
      }
      function closeModal() {
        modal.classList.remove('open'); modal.setAttribute('aria-hidden', 'true'); if (modal._cleanup) { try { modal._cleanup(); } catch(e){} modal._cleanup = null; } if (lastFocus && lastFocus.focus) lastFocus.focus();
      }
      modal.addEventListener('click', e => { if (e.target.matches('[data-close]')) closeModal(); });
      window.addEventListener('keydown', e => { if (e.key === 'Escape' && modal.classList.contains('open')) closeModal(); });
      mPrev.addEventListener('click', () => setImage(idx - 1));
      mNext.addEventListener('click', () => setImage(idx + 1));

      document.getElementById('catalog').addEventListener('click', function(e){
        const withinNoModal = e.target.closest('[data-nomodal]') || e.target.closest('.btnrow');
        if (withinNoModal) return;
        const card = e.target.closest('.card'); if (!card) return;
        const imagesAttr = (card.dataset.images || '').split(',').map(s => s.trim()).filter(Boolean);
        const colorsAttr = (card.dataset.colors || '').split('|').map(s => s.trim()).filter(Boolean);
        const data = { title: card.dataset.title, price: card.dataset.price, amount: card.dataset.amount, image: card.dataset.image, images: imagesAttr, longdesc: card.dataset.longdesc, colors: colorsAttr };
        openModal(data);
      });
    })();

    document.getElementById('year').textContent = new Date().getFullYear();
    ensurePaypalLoaded().then(renderPayPalButtonsOnCards);
  
</script>

<script>
// Robust image path resolver for GitHub repos with nested folders.
// Tries multiple relative bases and a jsDelivr fallback for raw.githubusercontent.com.
//
// How it works:
// 1) For each <img> and any modal image set from data-images, we attempt to load.
// 2) If it fails, we iterate through candidate bases until one loads.
// 3) If the URL was a raw.githubusercontent.com link, we auto-convert to jsDelivr as a last resort.
// 4) Filenames can be bare ('jason1.jpg') or relative ('./assets/jason1.jpg').

(function() {
  const CANDIDATE_BASES = [
    "",           // same folder as the HTML
    "./",
    "../",
    "../../",
    "img/",
    "./img/",
    "../img/",
    "../../img/",
    "assets/",
    "./assets/",
    "./assets/jason/",
    "../assets/",
    "../assets/jason/"
  ];

  function toJsDelivr(url) {
    // Convert raw GitHub URL to jsDelivr CDN
    // raw: https://cdn.jsdelivr.net/gh/USER/REPO@BRANCH/path/file.jpg
    // cdn: https://cdn.jsdelivr.net/gh/USER/REPO@BRANCH/path/file.jpg
    try {
      const m = url.match(/^https:\/\/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.+)$/);
      if (!m) return null;
      const [, user, repo, branch, rest] = m;
      return `https://cdn.jsdelivr.net/gh/${user}/${repo}@${branch}/${rest}`;
    } catch (e) {
      return null;
    }
  }

  async function tryLoad(url) {
    return new Promise((resolve, reject) => {
      const testImg = new Image();
      testImg.onload = () => resolve(url);
      testImg.onerror = () => reject(url);
      testImg.src = url + (url.includes("?") ? "&" : "?") + "cachebust=" + Date.now();
    });
  }

  async function resolveUrl(original, contextDir="") {
    // If it's an absolute http(s) URL, try as-is, then jsDelivr fallback if raw.*
    if (/^https?:\/\//i.test(original)) {
      try {
        return await tryLoad(original);
      } catch (e) {
        const alt = toJsDelivr(original);
        if (alt) {
          try {
            return await tryLoad(alt);
          } catch (e2) {}
        }
        throw new Error("All absolute attempts failed for " + original);
      }
    }

    // If it's a root-relative (/something), try as-is
    if (/^\//.test(original)) {
      try {
        return await tryLoad(original);
      } catch (e) {}
      // Also try without the leading slash (useful for GitHub Pages project path)
      const noRoot = original.replace(/^\//, "");
      for (const base of ["", "./"]) {
        const candidate = base + noRoot;
        try {
          return await tryLoad(candidate);
        } catch (e) {}
      }
      // Fall through to generic attempts
    }

    // Otherwise: relative/bare filename. Iterate candidate bases.
    const filename = original.replace(/^\.?\//, ""); // normalize
    const bases = [...new Set(CANDIDATE_BASES.map(b => {
      // If contextDir is provided, try that first
      if (contextDir && !/^https?:\/\//i.test(contextDir)) {
        return contextDir.replace(/\/+$/, "") + "/" + b;
      }
      return b;
    }))];

    for (const base of bases) {
      const candidate = (base ? base : "") + filename;
      try {
        return await tryLoad(candidate);
      } catch (e) {}
    }
    throw new Error("Failed to resolve: " + original);
  }

  // Patch all <img> elements: set data-src as source of truth if present, else use src.
  // Then resolve and replace on error automatically.
  function enhanceImg(img) {
    if (img.dataset._enhanced) return;
    img.dataset._enhanced = "1";

    const original = img.getAttribute("data-src") || img.getAttribute("src") || "";
    if (!original) return;

    let triedJsDelivr = false;

    const attempt = async (urlList) => {
      if (!urlList || !urlList.length) return;
      const [head, ...tail] = urlList;
      try {
        const finalUrl = await resolveUrl(head);
        img.src = finalUrl;
      } catch (e) {
        // If raw.* and not yet tried jsDelivr, push the converted URL next in line
        if (/^https:\/\/raw\.githubusercontent\.com\//.test(head) && !triedJsDelivr) {
          const alt = toJsDelivr(head);
          if (alt) tail.unshift(alt);
          triedJsDelivr = true;
        }
        await attempt(tail);
      }
    };

    // Build candidates: original, plus if it's bare filename, add candidates later
    const initialList = [original];
    attempt(initialList);

    img.onerror = function() {
      // On visible error, try again through the resolver (e.g., page moved)
      attempt([original]);
      img.onerror = null; // prevent infinite loops
    };
  }

  function splitDataImages(val) {
    return (val || "")
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);
  }

  async function resolveAll(urls) {
    const out = [];
    for (const u of urls) {
      try {
        const r = await resolveUrl(u);
        out.push(r);
      } catch (e) {
        // skip failures, keep going so gallery still works with what we can load
      }
    }
    return out;
  }

  document.addEventListener("DOMContentLoaded", async function() {
    // 1) Enhance every <img>
    document.querySelectorAll("img").forEach(enhanceImg);

    // 2) If products use data-image / data-images for modals, normalize them
    const productNodes = document.querySelectorAll("[data-image], [data-images]");
    for (const node of productNodes) {
      const single = node.getAttribute("data-image");
      const multi = node.getAttribute("data-images");

      if (single) {
        try {
          const resolved = await resolveUrl(single);
          node.setAttribute("data-image", resolved);
          // If there's an <img> inside without explicit src (or with failing src), set it
          const img = node.querySelector("img");
          if (img && (!img.getAttribute("src") || img.getAttribute("src").includes("raw.githubusercontent.com"))) {
            img.setAttribute("src", resolved);
          }
        } catch (e) {}
      }

      if (multi) {
        const urls = splitDataImages(multi);
        const resolvedList = await resolveAll(urls);
        if (resolvedList.length) {
          node.setAttribute("data-images", resolvedList.join(","));
        }
      }
    }
  });
})();
</script>
</body>
</html>
